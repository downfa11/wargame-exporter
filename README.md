# wargame metric exporter for Promehteus

**Wargame** is a real-time strategy game service.

This exporter was developed to collect **custom metrics** from an IOCP-based game server.

It reads JSON snapshots periodically generated by the server and exposes them in a **Prometheus-compatible format**.

Even if your server is not C++ based, this exporter can be useful for any service that produces **binary or structured metric snapshots**.


### Quick Start

```
# Default: Port 9100, Metrics file: /mnt/metrics/metrics_snapshot.json
./metrics-exporter

# Using environment variables
EXPORTER_PORT=9200 METRICS_FILE=/data/metrics.json ./metrics-exporter
```

### Prometheus scrape configruation**

```
scrape_configs:
  - job_name: 'iocp-game-server'
    static_configs:
      - targets: ['iocp-metrics-exporter:9100']
```

## Usage in kubernetes

The `/docs` directory contains **pattern-specific** examples for Kubernetes deployments.
Select the appropriate pattern according to your service scale:

1. **Sidecar Pattern** – Run the exporter as a sidecar container in the same Pod as the game server.

2. **Shared PVC Pattern** – Run the exporter in a separate Pod, sharing a PersistentVolumeClaim (PVC) with the game server.


## How to Configure the Server

The following example uses C++20.

The goal is to **minimize lock contention** and periodically create snapshots using **atomic writes**.
We maintain a global metrics structure and use a dedicated timer thread to periodically generate JSON snapshots via `nlohmann::json`.

```
#include <thread>
#include <chrono>
#include <fstream>
#include <nlohmann/json.hpp>
#include <atomic>

struct Metrics { // custom
    std::atomic<int> activePlayers{0};
    ...
};

void DumpMetricsSnapshot(const std::string& path) {
    nlohmann::json j;
    ...
}

void MetricsSnapshotThread() {
    while (true) {
        DumpMetricsSnapshot("/mnt/metrics/metrics_snapshot.json");
        std::this_thread::sleep_for(std::chrono::seconds(1));
    }
}

// server init:
std::thread metricsThread(MetricsSnapshotThread);
metricsThread.detach();
```

## Makefile
```
# Build the local Go binary
make build

# Build the Docker image
make docker-build

# Run the container (default port/file)
make run

# Change port or metrics file
make run EXPORTER_PORT=9200 METRICS_FILE=/data/metrics.json

# View logs
make logs

# Clean up
make dist-clean
```
